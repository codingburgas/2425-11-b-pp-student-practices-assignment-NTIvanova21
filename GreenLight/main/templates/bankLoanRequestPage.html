{% extends "base.html" %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='base_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('main.static', filename='homePageStyle.css') }}">
{% endblock %}

{% block filter_btn %}
    <div  id="filterButton" class="mb-3 d-flex gap-2">
        <h4>Filter by: </h4>
        <select id="loanFilter" class="form-select w-auto">
            <option value="all">All Loans</option>
            <option value="approved">Approved</option>
            <option value="disapproved">Not approved</option>
        </select>

    </div>
{% endblock %}
{% block content %}
    <div id="container">

        <table class="table table-striped table-bordered text-center align-middle">
            <thead class="table-light">
                <tr>
                    <th>Customer's full name</th>
                    <th>Model's prediction</th>
                    <th>Loan status</th>
                    <th>More info</th>
                </tr>
            </thead>
            <tbody>
                {% for item in users_with_loans %}
                    {% set modal_id = 'userModal_' ~ loop.index %}
                    <tr data-status="{{ 'approved' if item.loan.approved else 'disapproved' }}">
                        <td>{{ item.user.first_name }} {{ item.user.middle_name }} {{ item.user.last_name }}</td>
                        <td>{{ item.loan.prediction_result }}%</td>

                        <td>
                            {% if item.loan.approved %}
                                <div class="badge bg-success-subtle text-success border border-success px-2 py-1 rounded small">Approved</div>
                            {% else %}
                                <div class="badge bg-danger-subtle text-danger border border-danger px-2 py-1 rounded small">Not approved</div>
                            {% endif %}
                        </td>

                        <td>
                            <button type="button" class="btn btn-sm btn-info text-muted" data-bs-toggle="modal" data-bs-target="#{{ modal_id }}">
                                View Details
                            </button>
                        </td>
                    </tr>

                    <div class="modal fade" id="{{ modal_id }}" tabindex="-1" aria-labelledby="{{ modal_id }}Label" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-scrollable modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="{{ modal_id }}Label">Customer - {{ item.user.first_name }} {{ item.user.last_name }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body text-start">
                                    <h4>Loan Info</h4>
                                    <ul>
                                        <li><strong>Gender:</strong> {{ item.loan.gender }}</li>
                                        <li><strong>Marital Status:</strong> {{ item.loan.marital_status }}</li>
                                        <li><strong>Dependents:</strong> {{ item.loan.dependents }}</li>
                                        <li><strong>Education:</strong> {{ item.loan.education }}</li>
                                        <li><strong>Self-Employment:</strong> {{ item.loan.self_employment }}</li>
                                        <li><strong>Applicant Income:</strong> {{ item.loan.applicant_income }}€</li>
                                        <li><strong>Coapplicant Income:</strong> {{ item.loan.coapplicant_income }}€</li>
                                        <li><strong>Loan Amount:</strong> {{ item.loan.loan_amount }}€</li>
                                        <li><strong>Loan Term:</strong> {{ item.loan.loan_term }} months</li>
                                        <li><strong>Credit History:</strong> {% if item.loan.credit_history == 1 %}Good{% else %}Bad{% endif %}</li>
                                        <li><strong>Property Area:</strong> {{ item.loan.property_area }}</li>
                                        <li><strong>Date of Birth:</strong> {{ item.loan.date_of_birth.strftime('%Y-%m-%d') if item.loan.date_of_birth else 'N/A' }}</li>
                                        <li><strong>Prediction:</strong> {{ item.loan.prediction_result }}%</li>
                                    </ul>
                                </div>
                                <div class="approve-btns text-end align-center">
                                    <form method="POST" action="{{ url_for('main.approve_loan_requests', loanId=item.loan.loanId) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-success">Approve</button>
                                    </form>
                                    <form method="POST" action="{{ url_for('main.disapprove_loan_requests', loanId=item.loan.loanId) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-danger">Disapprove</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}

{% block extra_js %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Script loaded and DOM ready");

            const filterButton = document.getElementById('filterButton');
            const loanFilter = document.getElementById('loanFilter');

            filterButton.addEventListener('click', filterLoans);

            loanFilter.addEventListener('change', filterLoans);

            function filterLoans() {
                const selected = loanFilter.value;
                const rows = document.querySelectorAll('#container table tbody tr');

                rows.forEach(row => {
                    const status = row.getAttribute('data-status');
                    if (selected === 'all' || selected === status) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            filterLoans();
        });
    </script>
{% endblock %}